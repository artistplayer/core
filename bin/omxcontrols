#!/usr/bin/env bash
OMXPLAYER_DBUS_ADDR="/tmp/omxplayerdbus.${USER:-root}"
OMXPLAYER_DBUS_PID="/tmp/omxplayerdbus.${USER:-root}.pid"
export DBUS_SESSION_BUS_ADDRESS=`cat $OMXPLAYER_DBUS_ADDR`
export DBUS_SESSION_BUS_PID=`cat $OMXPLAYER_DBUS_PID`

[ -z "$DBUS_SESSION_BUS_ADDRESS" ] && { echo "Must have DBUS_SESSION_BUS_ADDRESS" >&2; exit 1; }

case $1 in
	get)
		case $2 in
			position)
				position=`dbus-send --print-reply=literal --session --reply-timeout=500 --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:"org.mpris.MediaPlayer2.Player" string:"Position"`
				[ $? -ne 0 ] && exit 1
				echo "$(awk '{print $2}' <<< "$position")"
				exit
				;;
			duration)
				duration=`dbus-send --print-reply=literal --session --reply-timeout=500 --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:"org.mpris.MediaPlayer2.Player" string:"Duration"`
				[ $? -ne 0 ] && exit 1
				echo "$(awk '{print $2}' <<< "$duration")"
				exit
				;;
			volume)
				awk -F"[][]" '/dB/ { print $2 }' <(amixer sget PCM)
				exit
				;;
			source)
				source=$(dbus-send --print-reply=literal --session --reply-timeout=500 --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.GetSource)
				[ $? -ne 0 ] && exit 1
				echo "$source" | sed 's/^ *//'
				exit
				;;
			status)
				playstatus=`dbus-send --print-reply=literal --session --reply-timeout=500 --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:"org.mpris.MediaPlayer2.Player" string:"PlaybackStatus"`
				[ $? -ne 0 ] && exit 1
				echo "$(sed 's/^ *//;s/ *$//;' <<< "$playstatus")"
			    exit
				;;
		esac
		;;
	set)
		case $2 in
			play)
				omxplayer $3 --pos $4 --vol 0 --amp 0 > /dev/null &
				exit
				;;
			pause)
				dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Action int32:16 >/dev/null
				exit
				;;
			stop)
				dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Action int32:15 >/dev/null
				exit
				;;
			seek)
				dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Seek int64:$2 >/dev/null
				exit
				;;
			position)
				dbus-send --print-reply=literal --session --dest=org.mpris.MediaPlayer2.omxplayer /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.SetPosition objpath:/not/used int64:$3 >/dev/null
				exit
				;;
			volume)
			    amixer sset 'PCM' $3 >/dev/null
			    exit
			    ;;
		esac
		;;
esac

echo "
Usage:
omxcontrols [method] [property] [value]

Methods:
    get: Get value of specific property
    set: Set value of specific property

Get Properties:
    position:       Get current position
    duration:       Get duration of current playing file
    volume:         Get current volume value
    source:         Get current source
    status:         Get the status of the omx player

Set Properties:
    play <file> <trim>:     Play a specific input <file> and <trim> some seconds from the beginning
    pause:                  Pause the current playing file
    stop:                   Stop the current playing file
    seek:                   Seek to a specific point
    volume:                 Set the current volume value
"